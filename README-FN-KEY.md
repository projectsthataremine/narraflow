# Fn Key Detection Research & Implementation

**Date**: 2025-01-10
**Status**: Implementation In Progress

## Problem Statement

We need to detect the macOS Fn/Globe key for use as the primary recording hotkey, matching Wispr Flow's functionality. The Fn key is NOT accessible through standard keyboard hooks like `uiohook-napi`.

## Research Findings

### Why Standard Libraries Don't Work

- ❌ **uiohook-napi**: Does NOT support Fn key detection
- ❌ **iohook**: Has macOS compatibility issues, does NOT support Fn key
- ❌ **node-global-key-listener**: Archived, does NOT support Fn key
- ❌ **Electron globalShortcut**: Unreliable for Fn key detection

### The Solution: Custom Native Module

Wispr Flow successfully uses Fn key because they built a **custom native module** using macOS APIs directly.

## Technical Implementation

### Fn Key Details on macOS

- **Key Code**: `63` (or `0x3F`)
- **NSEvent Modifier Flag**: `.function`
- **CGEvent Flag**: `kCGEventFlagMaskSecondaryFn`
- **Detection Method**: Monitor `NSEvent.flagsChanged` events
- **Requirement**: Accessibility permissions from user

### Architecture

```
Native Module (Swift/Objective-C)
    ↓
N-API Bridge (C++)
    ↓
JavaScript (Node.js/Electron)
    ↓
shortcuts.ts (existing hotkey system)
```

## Implementation Code

### 1. Swift Listener (FnKeyListener.swift)

```swift
import Cocoa

@objc public class FnKeyListener: NSObject {
    private var monitor: Any?
    private var callback: ((Bool) -> Void)?

    @objc public func startListening(_ callback: @escaping (Bool) -> Void) {
        self.callback = callback

        monitor = NSEvent.addGlobalMonitorForEvents(matching: .flagsChanged) { [weak self] event in
            if event.keyCode == 63 {
                let isFnPressed = event.modifierFlags.contains(.function)
                self?.callback?(isFnPressed)
            }
        }
    }

    @objc public func stopListening() {
        if let monitor = monitor {
            NSEvent.removeMonitor(monitor)
        }
    }
}
```

### 2. Objective-C Bridge (SwiftBridge.h)

```objc
#import <Foundation/Foundation.h>

@interface SwiftBridge : NSObject
+ (void)startListening:(void (^)(BOOL))callback;
+ (void)stopListening;
@end
```

### 3. N-API Wrapper (fn_key_addon.mm)

```cpp
#include <napi.h>
#import "SwiftBridge.h"

class FnKeyAddon : public Napi::ObjectWrap<FnKeyAddon> {
public:
    static Napi::Object Init(Napi::Env env, Napi::Object exports);
    FnKeyAddon(const Napi::CallbackInfo& info);

private:
    Napi::Value StartListening(const Napi::CallbackInfo& info);
    Napi::Value StopListening(const Napi::CallbackInfo& info);

    Napi::FunctionReference callback;
};

// Implementation handles callbacks from Swift → JavaScript
```

### 4. Build Configuration (binding.gyp)

```json
{
  "targets": [{
    "target_name": "fn_key_addon",
    "conditions": [
      ['OS=="mac"', {
        "sources": [
          "native/src/fn_key_addon.mm",
          "native/src/SwiftBridge.m",
          "native/src/FnKeyListener.swift"
        ],
        "xcode_settings": {
          "SWIFT_VERSION": "5.0",
          "MACOSX_DEPLOYMENT_TARGET": "11.0",
          "OTHER_LDFLAGS": [
            "-framework AppKit",
            "-framework Carbon"
          ]
        }
      }]
    ],
    "include_dirs": [
      "<!@(node -p \"require('node-addon-api').include\")",
      "native/include"
    ]
  }]
}
```

## Project Structure

```
/Users/joshuaarnold/Dev/Mic2Text/
├── native/                        # NEW: Native addon code
│   ├── binding.gyp               # Build configuration
│   ├── include/
│   │   └── SwiftBridge.h         # Objective-C header
│   ├── src/
│   │   ├── FnKeyListener.swift   # Swift implementation
│   │   ├── SwiftBridge.m         # Objective-C bridge
│   │   └── fn_key_addon.mm       # N-API wrapper
│   └── build/                    # Generated by node-gyp
│       └── Release/
│           └── fn_key_addon.node # Compiled native module
├── src/
│   └── main/
│       └── shortcuts.ts          # MODIFY: Use native module
└── package.json                  # ADD: native dependencies
```

## Integration with Existing Code

### Modified shortcuts.ts

```typescript
// Load native Fn key listener (macOS only)
let fnKeyListener: any = null;
if (process.platform === 'darwin') {
  try {
    fnKeyListener = require('../../native/build/Release/fn_key_addon.node');
  } catch (error) {
    console.error('[Shortcuts] Failed to load Fn key native module:', error);
  }
}

export function registerShortcuts(window: BrowserWindow, hotkeyConfig: HotkeyConfig): boolean {
  // If hotkey is Fn key and we have the native module
  if (hotkeyConfig.key === 'Fn' && fnKeyListener && process.platform === 'darwin') {
    const listener = new fnKeyListener.FnKeyAddon();

    listener.startListening((isFnPressed: boolean) => {
      if (isFnPressed && !isRecording) {
        handleKeyPress();
      } else if (!isFnPressed && isRecording) {
        handleKeyRelease();
      }
    });

    return true;
  }

  // Fallback to uiohook-napi for other keys
  // ... existing code ...
}
```

## Build Process

```bash
# Install native build tools
npm install --save-dev node-gyp @electron/rebuild

# Install N-API dependencies
npm install --save node-addon-api bindings

# Build native module
npx node-gyp configure
npx node-gyp build

# Rebuild for Electron
npx electron-rebuild
```

## Requirements

### System Requirements

1. **Xcode Command Line Tools**: `xcode-select --install`
2. **Swift 5.0+**: Included with Xcode
3. **macOS 11.0+**: For NSEvent API support
4. **Accessibility Permissions**: User must grant in System Settings

### Package Dependencies

```json
{
  "dependencies": {
    "node-addon-api": "^8.3.0",
    "bindings": "^1.5.0"
  },
  "devDependencies": {
    "node-gyp": "^11.1.0",
    "@electron/rebuild": "^3.6.0"
  }
}
```

## Accessibility Permissions

The app MUST request Accessibility permissions to monitor global keyboard events:

```typescript
import { systemPreferences } from 'electron';

// Check and request permissions
if (!systemPreferences.isTrustedAccessibilityClient(false)) {
  // This will prompt the user
  systemPreferences.isTrustedAccessibilityClient(true);

  console.log('Please grant Accessibility permissions in System Settings');
}
```

## Testing Strategy

1. **Test on Apple Keyboard**: Internal MacBook keyboard
2. **Test on External Keyboard**: Apple Magic Keyboard
3. **Test Non-Apple Keyboard**: May not work (hardware limitation)
4. **Test Press/Release**: Ensure events fire correctly
5. **Test with Recording**: Verify integration with recording pipeline

## Known Limitations

1. **Apple Keyboards Only**: Non-Apple keyboards may not send proper Fn key events
2. **No Cross-Platform**: This solution is macOS-specific
3. **Requires Native Compilation**: Must rebuild for each Electron version
4. **Accessibility Required**: User must grant permissions manually

## Alternative Hotkeys

If native module fails to compile or user denies permissions, fallback to:

1. **CapsLock** (currently working)
2. **F13-F16** (works with uiohook-napi)
3. **Command+B** (works with uiohook-napi)

## References

- **Electron + Swift Tutorial**: https://www.electronjs.org/docs/latest/tutorial/native-code-and-electron-swift-macos
- **NSEvent Documentation**: https://developer.apple.com/documentation/appkit/nsevent
- **CGEvent Documentation**: https://developer.apple.com/documentation/coregraphics/cgevent
- **Proof of Concept**: https://github.com/codebytere/node-mac-swift-addon

## Implementation Status

- [x] Research completed
- [x] Documentation written
- [ ] Native module structure created
- [ ] Swift listener implemented
- [ ] Objective-C bridge implemented
- [ ] N-API wrapper implemented
- [ ] binding.gyp configured
- [ ] Build tested
- [ ] Integration with shortcuts.ts
- [ ] Testing on macOS
- [ ] Fallback handling for compile failures

## Next Steps

1. Create `native/` directory structure
2. Implement Swift FnKeyListener
3. Create Objective-C bridge
4. Write N-API wrapper
5. Configure binding.gyp
6. Build and test
7. Integrate with shortcuts.ts
8. Update settings UI to include Fn key option
9. Test end-to-end recording with Fn key
